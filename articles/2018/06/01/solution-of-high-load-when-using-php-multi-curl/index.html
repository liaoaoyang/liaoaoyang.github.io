<!doctype html>
<html class="theme-next   use-motion ">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <!--<link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">-->
  <link href="/vendors/googleapis/css/Lato.css" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.4.5.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="PHP,cURL,curlmulti," />





  <link rel="alternate" href="/atom.xml" title="A Programmer" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.2" />






<meta name="description" content="TL;DR如果选择通过 curl_multi_* 函数并行发起请求，需要在使用 curl_multi_select 返回 -1 时增加休眠时间以降低 load。形如（代码来自 Guzzle）：
12345if ($this-&amp;gt;active &amp;amp;&amp;amp;    curl_multi_select($this-&amp;gt;_mh, $this-&amp;gt;selectTimeout) === -">
<meta property="og:type" content="article">
<meta property="og:title" content="降低使用PHP Curl_multi_* 时的 Load">
<meta property="og:url" content="http://www.liaoaoyang.com/articles/2018/06/01/solution-of-high-load-when-using-php-multi-curl/index.html">
<meta property="og:site_name" content="A Programmer">
<meta property="og:description" content="TL;DR如果选择通过 curl_multi_* 函数并行发起请求，需要在使用 curl_multi_select 返回 -1 时增加休眠时间以降低 load。形如（代码来自 Guzzle）：
12345if ($this-&amp;gt;active &amp;amp;&amp;amp;    curl_multi_select($this-&amp;gt;_mh, $this-&amp;gt;selectTimeout) === -">
<meta property="og:updated_time" content="2021-10-23T05:16:33.486Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="降低使用PHP Curl_multi_* 时的 Load">
<meta name="twitter:description" content="TL;DR如果选择通过 curl_multi_* 函数并行发起请求，需要在使用 curl_multi_select 返回 -1 时增加休眠时间以降低 load。形如（代码来自 Guzzle）：
12345if ($this-&amp;gt;active &amp;amp;&amp;amp;    curl_multi_select($this-&amp;gt;_mh, $this-&amp;gt;selectTimeout) === -">



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: '',
    sidebar: 'post',
    motion: true
  };
</script>

  <title> 降低使用PHP Curl_multi_* 时的 Load | A Programmer </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-74385074-5', 'auto');
  ga('send', 'pageview');
</script>





  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">A Programmer</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                降低使用PHP Curl_multi_* 时的 Load
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2018-06-01T09:51:09+08:00" content="2018-06-01">
              2018-06-01
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/PHP/" itemprop="url" rel="index">
                    <span itemprop="name">PHP</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        <span itemprop="articleBody"><h1 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h1><p>如果选择通过 <code>curl_multi_*</code> 函数并行发起请求，需要在使用 <code>curl_multi_select</code> 返回 -1 时增加休眠时间以降低 load。形如（代码来自 Guzzle）：</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$this-</span>&gt;active &amp;&amp;</span><br><span class="line">    curl_multi_select(<span class="variable">$this-</span>&gt;_mh, <span class="variable">$this-</span>&gt;selectTimeout) === -<span class="number">1</span></span><br><span class="line">) &#123;</span><br><span class="line">    usleep(<span class="number">250</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用的软件版本为：</p>
<ul>
<li>PHP 5.4.41</li>
<li>libcurl 7.19</li>
<li>Guzzle 5.3</li>
</ul>
<!-- solution-of-high-load-when-using-php-multi-curl -->
<a id="more"></a>
<h1 id="curl-multi"><a href="#curl-multi" class="headerlink" title="curl_multi_*"></a>curl_multi_*</h1><p>如果要并发的发起请求，PHP 可以通过多进程发起请求的方式实现，每个请求由一个进程执行，然而这一方式开发以及运行成本较高，带来了繁重的进程管理以及 IPC 的编码工作。</p>
<p>进程是重量级的，而连接较之进程是轻量级的，结合IO多路复用可以让并发发起网络请求的成本降低，<code>curl_multi*</code> 这一组函数就是 PHP 基于 <code>libcurl</code> 封装的并发发起请求的工具。</p>
<p>网络上一些博文声称这一族函数是多线程发起请求，然而<a href="https://curl.haxx.se/libcurl/c/libcurl-tutorial.html" target="_blank" rel="external">libcurl官网</a>的文档中的 <strong>The multi Interface</strong> 部分说得很清楚，与这些博文相反：</p>
<blockquote>
<p>The multi interface, on the other hand, allows your program to transfer multiple files in both directions at the same time, without forcing you to use multiple threads. The name might make it seem that the multi interface is for multi-threaded programs, but the truth is almost the reverse. The multi interface allows a single-threaded application to perform the same kinds of multiple, simultaneous transfers that multi-threaded programs can perform.</p>
</blockquote>
<p>编码上，通过 <a href="http://php.net/manual/en/function.curl-multi-init.php" target="_blank" rel="external"><code>curl_multi_init</code></a> 创建并行请求处理对象，加入多个普通的 curl 对象；通过 <a href="http://php.net/manual/en/function.curl-multi-exec.php" target="_blank" rel="external"><code>curl_multi_exec</code></a> 按照内置的状态机建立连接，传输数据；使用 <a href="http://php.net/manual/en/function.curl-multi-select.php" target="_blank" rel="external"><code>curl_multi_select</code></a> 获取活跃的连接；之后尝试读取当中活跃连接的信息，记录对端返回的数据。</p>
<p>还是以 Guzzle 作为样板，选出最重要的执行过程，参见文件 <code>guzzlehttp/ringphp/src/Client/CurlMultiHandler.php</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Runs until all outstanding connections have completed.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">execute</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$this</span>-&gt;active &amp;&amp;</span><br><span class="line">            curl_multi_select(<span class="variable">$this</span>-&gt;_mh, <span class="variable">$this</span>-&gt;selectTimeout) === -<span class="number">1</span></span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="comment">// Perform a usleep if a select returns -1.</span></span><br><span class="line">            <span class="comment">// See: https://bugs.php.net/bug.php?id=61141</span></span><br><span class="line">            usleep(<span class="number">250</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Add any delayed futures if needed.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$this</span>-&gt;delays) &#123;</span><br><span class="line">            <span class="variable">$this</span>-&gt;addDelays();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="variable">$mrc</span> = curl_multi_exec(<span class="variable">$this</span>-&gt;_mh, <span class="variable">$this</span>-&gt;active);</span><br><span class="line">        &#125; <span class="keyword">while</span> (<span class="variable">$mrc</span> === CURLM_CALL_MULTI_PERFORM);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$this</span>-&gt;processMessages();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If there are delays but no transfers, then sleep for a bit.</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$this</span>-&gt;active &amp;&amp; <span class="variable">$this</span>-&gt;delays) &#123;</span><br><span class="line">            usleep(<span class="number">500</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">while</span> (<span class="variable">$this</span>-&gt;active || <span class="variable">$this</span>-&gt;handles);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">processMessages</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="variable">$done</span> = curl_multi_info_read(<span class="variable">$this</span>-&gt;_mh)) &#123;</span><br><span class="line">        <span class="variable">$id</span> = (int) <span class="variable">$done</span>[<span class="string">'handle'</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$this</span>-&gt;handles[<span class="variable">$id</span>])) &#123;</span><br><span class="line">            <span class="comment">// Probably was cancelled.</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$entry</span> = <span class="variable">$this</span>-&gt;handles[<span class="variable">$id</span>];</span><br><span class="line">        <span class="variable">$entry</span>[<span class="string">'response'</span>][<span class="string">'transfer_stats'</span>] = curl_getinfo(<span class="variable">$done</span>[<span class="string">'handle'</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$done</span>[<span class="string">'result'</span>] !== CURLM_OK) &#123;</span><br><span class="line">            <span class="variable">$entry</span>[<span class="string">'response'</span>][<span class="string">'curl'</span>][<span class="string">'errno'</span>] = <span class="variable">$done</span>[<span class="string">'result'</span>];</span><br><span class="line">            <span class="keyword">if</span> (function_exists(<span class="string">'curl_strerror'</span>)) &#123;</span><br><span class="line">                <span class="variable">$entry</span>[<span class="string">'response'</span>][<span class="string">'curl'</span>][<span class="string">'error'</span>] = curl_strerror(<span class="variable">$done</span>[<span class="string">'result'</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$result</span> = CurlFactory::createResponse(</span><br><span class="line">            <span class="variable">$this</span>,</span><br><span class="line">            <span class="variable">$entry</span>[<span class="string">'request'</span>],</span><br><span class="line">            <span class="variable">$entry</span>[<span class="string">'response'</span>],</span><br><span class="line">            <span class="variable">$entry</span>[<span class="string">'headers'</span>],</span><br><span class="line">            <span class="variable">$entry</span>[<span class="string">'body'</span>]</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="variable">$this</span>-&gt;removeProcessed(<span class="variable">$id</span>);</span><br><span class="line">        <span class="variable">$entry</span>[<span class="string">'deferred'</span>]-&gt;resolve(<span class="variable">$result</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="curl-multi-select-之后的-usleep"><a href="#curl-multi-select-之后的-usleep" class="headerlink" title="curl_multi_select 之后的 usleep()"></a>curl_multi_select 之后的 usleep()</h1><p>Guzzle 作为优秀的 PHP HTTP 客户端，实现上在 <code>curl_multi_select</code> 返回 <strong>-1</strong> 时会休眠，这是降低 load 的一个看起来比较奇怪的关键操作。</p>
<h2 id="不带-sleep-usleep-的实现导致的问题"><a href="#不带-sleep-usleep-的实现导致的问题" class="headerlink" title="不带 sleep/usleep 的实现导致的问题"></a>不带 sleep/usleep 的实现导致的问题</h2><p>有部分的代码实现上并没有在这一情况下进行休眠，导致的问题是 CPU 使用率过高，导致服务器 load 上升。</p>
<p>load 与 CPU 使用时间有关系，当 CPU 繁忙时，服务器 load 会升高。常见的让服务器 CPU 飙升的操作就是死循环或者执行时间极短的不带休眠的循环。</p>
<p>例如以下的实现：</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$running</span> = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">while</span> (<span class="variable">$running</span>)</span><br><span class="line">&#123;</span><br><span class="line">    if (CURLM_CALL_MULTI_PERFORM == curl_multi_exec(<span class="variable">$mh</span>, <span class="variable">$running</span>)) &#123;</span><br><span class="line">        continue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    curl_multi_select(<span class="variable">$mh</span>, <span class="variable">$selectTimeout</span>);</span><br><span class="line">    </span><br><span class="line">    while (<span class="variable">$ret</span> = curl_multi_info_read(<span class="variable">$mh</span>, <span class="variable">$id</span>)) &#123;</span><br><span class="line">        // ETC     </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>就会在服务器上就会引起服务器 load 上升。</p>
<h2 id="PHP-curl-multi-select-实现"><a href="#PHP-curl-multi-select-实现" class="headerlink" title="PHP curl_multi_select 实现"></a>PHP curl_multi_select 实现</h2><p>不带休眠的实现会引起服务器 load 上升，要从 PHP <code>curl_multi_select</code> 的实现说起。</p>
<p>PHP 内核源码中自带了 curl 扩展的源码，在 <code>ext/curl/multi.c</code> 文件中可以看到这一函数的实现：</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">/* </span><span class="expression">&#123;&#123;&#123; <span class="variable">proto</span> <span class="variable">int</span> <span class="variable">curl</span>_<span class="variable">multi</span>_<span class="variable">select</span>(<span class="variable">resource</span> <span class="variable">mh</span>[, <span class="variable">double</span> <span class="variable">timeout</span>])</span><br><span class="line">   <span class="variable">Get</span> <span class="variable">all</span> <span class="variable">the</span> <span class="variable">sockets</span> <span class="variable">associated</span> <span class="variable"><span class="keyword">with</span></span> <span class="variable">the</span> <span class="variable">cURL</span> <span class="variable">extension</span>, <span class="variable">which</span> <span class="variable">can</span> <span class="variable">then</span> <span class="variable">be</span> <span class="string">"selected"</span> */</span><br><span class="line"><span class="variable">PHP</span>_<span class="variable">FUNCTION</span>(<span class="variable">curl</span>_<span class="variable">multi</span>_<span class="variable">select</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="variable">zval</span>           *<span class="variable">z</span>_<span class="variable">mh</span>;</span><br><span class="line">	<span class="variable">php</span>_<span class="variable">curlm</span>      *<span class="variable">mh</span>;</span><br><span class="line">	<span class="variable">fd</span>_<span class="variable">set</span>          <span class="variable">readfds</span>;</span><br><span class="line">	<span class="variable">fd</span>_<span class="variable">set</span>          <span class="variable">writefds</span>;</span><br><span class="line">	<span class="variable">fd</span>_<span class="variable">set</span>          <span class="variable">exceptfds</span>;</span><br><span class="line">	<span class="variable">int</span>             <span class="variable">maxfd</span>;</span><br><span class="line">	<span class="variable">double</span>          <span class="variable">timeout</span> = 1<span class="variable">.</span>0;</span><br><span class="line">	<span class="variable">struct</span> <span class="variable">timeval</span>  <span class="variable">to</span>;</span><br><span class="line"></span><br><span class="line">	<span class="variable"><span class="keyword">if</span></span> (<span class="variable">zend</span>_<span class="variable">parse</span>_<span class="variable">parameters</span>(<span class="variable">ZEND</span>_<span class="variable">NUM</span>_<span class="variable">ARGS</span>() <span class="variable">TSRMLS</span>_<span class="variable">CC</span>, <span class="string">"r|d"</span>, &amp;<span class="variable">z</span>_<span class="variable">mh</span>, &amp;<span class="variable">timeout</span>) == <span class="variable">FAILURE</span>) &#123;</span><br><span class="line">		<span class="variable">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="variable">ZEND</span>_<span class="variable">FETCH</span>_<span class="variable">RESOURCE</span>(<span class="variable">mh</span>, <span class="variable">php</span>_<span class="variable">curlm</span> *, &amp;<span class="variable">z</span>_<span class="variable">mh</span>, <span class="variable">-</span>1, <span class="variable">le</span>_<span class="variable">curl</span>_<span class="variable">multi</span>_<span class="variable">handle</span>_<span class="variable">name</span>, <span class="variable">le</span>_<span class="variable">curl</span>_<span class="variable">multi</span>_<span class="variable">handle</span>);</span><br><span class="line"></span><br><span class="line">	_<span class="variable">make</span>_<span class="variable">timeval</span>_<span class="variable">struct</span>(&amp;<span class="variable">to</span>, <span class="variable">timeout</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="variable">FD</span>_<span class="variable">ZERO</span>(&amp;<span class="variable">readfds</span>);</span><br><span class="line">	<span class="variable">FD</span>_<span class="variable">ZERO</span>(&amp;<span class="variable">writefds</span>);</span><br><span class="line">	<span class="variable">FD</span>_<span class="variable">ZERO</span>(&amp;<span class="variable">exceptfds</span>);</span><br><span class="line"></span><br><span class="line">	<span class="variable">curl</span>_<span class="variable">multi</span>_<span class="variable">fdset</span>(<span class="variable">mh-</span>&gt;<span class="variable">multi</span>, &amp;<span class="variable">readfds</span>, &amp;<span class="variable">writefds</span>, &amp;<span class="variable">exceptfds</span>, &amp;<span class="variable">maxfd</span>);</span><br><span class="line">	<span class="variable"><span class="keyword">if</span></span> (<span class="variable">maxfd</span> == <span class="variable">-</span>1) &#123;</span><br><span class="line">		<span class="variable">RETURN</span>_<span class="variable">LONG</span>(<span class="variable">-</span>1);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable">RETURN</span>_<span class="variable">LONG</span>(<span class="variable">select</span>(<span class="variable">maxfd</span> + 1, &amp;<span class="variable">readfds</span>, &amp;<span class="variable">writefds</span>, &amp;<span class="variable">exceptfds</span>, &amp;<span class="variable">to</span>));</span><br><span class="line">&#125;</span><br><span class="line">/* &#125;&#125;</span><span class="xml">&#125; */</span></span><br></pre></td></tr></table></figure>
<p>文档上提及：</p>
<blockquote>
<p>On success, returns the number of descriptors contained in the descriptor sets. This may be 0 if there was no activity on any of the descriptors. On failure, this function will return -1 on a select failure (from the underlying select system call).</p>
</blockquote>
<p>即 -1 只在 <code>select</code> 系统调用失败时返回。 </p>
<p>由于请求是用户主动发起的，select 系统调用的监听集合需要通过某种方式获取，在这个编程模型下，<code>curl_multi_fdset</code> 就是产生监听集合的方法。</p>
<p>然而在实现中除去 PHP 函数的一些基本操作，可以看到返回 -1 的情况还会在 libcurl 的库函数 <code>curl_multi_fdset</code> 的 <code>maxfd</code> 变量被修改为 -1 后出现。</p>
<p><a href="https://curl.haxx.se/libcurl/c/curl_multi_fdset.html" target="_blank" rel="external">libcurl 的 curl_multi_fdset</a> 文档里提到的一段话值得注意：</p>
<blockquote>
<p>If no file descriptors are set by libcurl, max_fd will contain -1 when this function returns. Otherwise it will contain the highest descriptor number libcurl set. When libcurl returns -1 in max_fd, it is because libcurl currently does something that isn’t possible for your application to monitor with a socket and unfortunately you can then not know exactly when the current action is completed using select(). You then need to wait a while before you proceed and call curl_multi_perform anyway. How long to wait? Unless curl_multi_timeout gives you a lower number, we suggest 100 milliseconds or so, but you may want to test it out in your own particular conditions to find a suitable value.</p>
</blockquote>
<p>即 max_fd 返回 -1 时，需要主动休眠 100ms 或者根据实际情况决定。</p>
<p>在 PHP 执行过程中，我们无法判断是 select 系统调用返回的 -1 还是 <code>curl_multi_fdset</code> 的 <code>max_fd</code> 返回的 -1。</p>
<p>而当 <code>curl_multi_fdset</code> 的 <code>max_fd</code> 返回 -1 时，说明 fd 集合中没有可以读写的 fd，应当避免频繁轮询 <code>curl_multi_fdset</code> 这个函数，导致占满 CPU。</p>
<h1 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h1><p>推广到 PHP 扩展方法 <code>curl_multi_select</code> 的调用，可以得知当返回 <strong>-1</strong> 时，不应该继续轮询请求 <code>curl_mutli_exec</code> / <code>curl_multi_select</code>，应当主动休眠，降低CPU占用。</p>
</span>
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/PHP/" rel="tag">#PHP</a>
          
            <a href="/tags/cURL/" rel="tag">#cURL</a>
          
            <a href="/tags/curlmulti/" rel="tag">#curlmulti</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/articles/2018/05/12/notes-of-php-design-patterns/" rel="next" title="PHP设计模式学习笔记">
                <i class="fa fa-chevron-left"></i> PHP设计模式学习笔记
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/articles/2018/07/28/a-tour-to-kota-kinabalu/" rel="prev" title="亚庇">
                亚庇 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


        </div>

        


        
  <div class="comments" id="comments">
    
  </div>


      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a href="/about">
          	<img class="site-author-image" src="https://blog.wislay.com/wp-content/uploads/2017/03/hippo.jpeg" alt="liaoaoyang" itemprop="image"/>
          </a>
          <p class="site-author-name" itemprop="name">liaoaoyang</p>
        </div>
        <p class="site-description motion-element" itemprop="description"></p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">105</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">12</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">91</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="/" target="_blank">
                  
                    <i class="fa fa-globe"></i> Homepage
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/wislay/" target="_blank">
                  
                    <i class="fa fa-weibo"></i> Weibo
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://github.com/liaoaoyang/" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator">
            <i class="fa fa-angle-double-up"></i>
          </div>
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#TL-DR"><span class="nav-number">1.</span> <span class="nav-text">TL;DR</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#curl-multi"><span class="nav-number">2.</span> <span class="nav-text">curl_multi_*</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#curl-multi-select-之后的-usleep"><span class="nav-number">3.</span> <span class="nav-text">curl_multi_select 之后的 usleep()</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#不带-sleep-usleep-的实现导致的问题"><span class="nav-number">3.1.</span> <span class="nav-text">不带 sleep/usleep 的实现导致的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PHP-curl-multi-select-实现"><span class="nav-number">3.2.</span> <span class="nav-text">PHP curl_multi_select 实现</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#结论"><span class="nav-number">4.</span> <span class="nav-text">结论</span></a></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator">
            <i class="fa fa-angle-double-down"></i>
          </div>
        </section>
      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">liaoaoyang</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>
</div>





      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
    
    

  


  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
<script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

<script type="text/javascript" src="/js/motion.js?v=0.4.5.2" id="motion.global"></script>


  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  
<script type="text/javascript" src="/js/bootstrap.scrollspy.js?v=0.4.5.2" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 1 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    motionMiddleWares.sidebar = function () {
      var $tocContent = $('.post-toc-content');
      if (CONFIG.sidebar === 'post') {
        if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
          displaySidebar();
        }
      }
    };
  });
</script>



  <script type="text/javascript" src="/js/bootstrap.js"></script>

  
  

  
  

</body>
</html>
